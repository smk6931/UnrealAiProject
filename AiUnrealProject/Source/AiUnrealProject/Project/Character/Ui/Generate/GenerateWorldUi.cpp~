// Fill out your copyright notice in the Description page of Project Settings.


#include "GenerateWorldUi.h"

#include "GenerateMonsterUi.h"
#include "JsonObjectConverter.h"
#include "Blueprint/WidgetTree.h"
#include "Components/Button.h"
#include "Components/TextBlock.h"
#include "Components/VerticalBox.h"

void UGenerateWorldUi::NativeConstruct()
{
	Super::NativeConstruct();
	Api = NewObject<UApiWorldObject>(this);
	Button_Image->SetVisibility(ESlateVisibility::Collapsed);
	
	Button_Create->OnClicked.AddDynamic(this, &UGenerateWorldUi::OnCreateClick);
	Button_Close->OnClicked.AddDynamic(this, &UGenerateWorldUi::OnCreateClick); 
	Button_Item->OnClicked.AddDynamic(this, &UGenerateWorldUi::OnCreateClick); 
	Button_Image->OnClicked.AddDynamic(this, &UGenerateWorldUi::OnCreateClick);
	
	InputQuestion->OnTextCommitted.AddDynamic(this, &UGenerateWorldUi::OnInputQuestion);
	// InputQuestion->OnTextChanged.AddDynamic(this, &UMyWidget::OnInputChanged);
}

void UGenerateWorldUi::OnCreateClick()
{
}

void UGenerateWorldUi::OnCloseClick()
{
}

void UGenerateWorldUi::OnItemClick()
{
}

void UGenerateWorldUi::OnImageClick()
{
}

void UGenerateWorldUi::OnWorldClick()
{
}

void UGenerateWorldUi::OnInputQuestion(const FText& Text, ETextCommit::Type CommitMethod)
{
	if (CommitMethod == ETextCommit::OnEnter)
	{
		UTextBlock* ResponseWorld = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
		ResponseWorld->SetFont(FCoreStyle::GetDefaultFontStyle("Regular", 16));
		Api->OnWorldInfoResponse.BindLambda([this,ResponseWorld](FString String)
		{
			this->InputQuestion->SetVisibility(ESlateVisibility::Collapsed);
			
			FWorldRowsWithEmbed RowsWithEmbed;
			FJsonObjectConverter::JsonObjectStringToUStruct(String, &RowsWithEmbed);
			UE_LOG(LogTemp,Warning,TEXT("OnInputQuestion 최종응답 결과 생성된 세계관 제목 %s"),*RowsWithEmbed.Response[0].title)

			UE_LOG(LogTemp,Warning,TEXT("OnInputQuestion 최종응답 결과   유사 세계관 값 %s"),*RowsWithEmbed.Response_Embed[0].title);
			UE_LOG(LogTemp,Warning,TEXT("OnInputQuestion 최종응답 결과   유사 임베딩 값 %.0f"),RowsWithEmbed.Response_Embed[0].similarity);

			UTextBlock* TitleT = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			TitleT->SetText(FText::FromString(TEXT("생성된 세계관 제목")));
			TitleT->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
			TitleT->SetColorAndOpacity(FSlateColor(FColor::Yellow));
			
			UTextBlock* Title = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			Title->SetText(FText::FromString(RowsWithEmbed.Response[0].title));
			Title->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));

			UTextBlock* ContentT = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			ContentT->SetText(FText::FromString(TEXT("생성된 세계관 내용")));
			ContentT->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
			ContentT->SetColorAndOpacity(FSlateColor(FColor::Yellow));
		    
		    UTextBlock* Content = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
		    Content->SetText(FText::FromString(RowsWithEmbed.Response[0].content));
		    Content->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
		    Content->SetAutoWrapText(true);
			
			this->RightVerticalBox->AddChild(TitleT);
		    this->RightVerticalBox->AddChild(Title);
		    this->RightVerticalBox->AddChild(ContentT);
		    this->RightVerticalBox->AddChild(Content);
			
		    for (FWorldRow Row : RowsWithEmbed.Response_Embed)
		    {
		    	UTextBlock* TitleEmbedT = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
				TitleEmbedT->SetText(FText::FromString(TEXT("유사도 세계관 제목")));
				TitleEmbedT->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
				TitleEmbedT->SetColorAndOpacity(FSlateColor(FColor::Yellow));
		    	
		    	UTextBlock* TitleEmbed = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			    TitleEmbed->SetText(FText::FromString(RowsWithEmbed.Response_Embed[0].title));
			    TitleEmbed->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));

		    	UTextBlock* EmbedValueT = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
				EmbedValueT->SetText(FText::FromString(TEXT("유사도 측정")));
				EmbedValueT->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
				EmbedValueT->SetColorAndOpacity(FSlateColor(FColor::Yellow));
    
			    UTextBlock* EmbedValue = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			    EmbedValue->SetText(FText::AsNumber(RowsWithEmbed.Response_Embed[0].similarity));
			    EmbedValue->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
			    EmbedValue->SetAutoWrapText(true);

		    	UTextBlock* EmbedReasonT = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
				EmbedReasonT->SetText(FText::FromString(TEXT("유사도 측정")));
				EmbedReasonT->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
				EmbedReasonT->SetColorAndOpacity(FSlateColor(FColor::Yellow));
    
				UTextBlock* EmbedReason = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
				EmbedReason->SetText(FText::FromString(RowsWithEmbed.Response_Embed[0].similar_reason));
				EmbedReason->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
				EmbedReason->SetAutoWrapText(true);

				this->LeftVerticalBox->AddChild(TitleEmbedT);
			    this->LeftVerticalBox->AddChild(TitleEmbed);
		    	this->LeftVerticalBox->AddChild(EmbedValueT);
			    this->LeftVerticalBox->AddChild(EmbedValue);
		    	this->LeftVerticalBox->AddChild(EmbedReasonT);
				this->LeftVerticalBox->AddChild(EmbedReason);
		    }
		    
			
			
			// FWorldRows Rows;
			// FJsonObjectConverter::JsonObjectStringToUStruct(String, &Rows);
			//
			// UE_LOG(LogTemp, Warning, TEXT("OnInputQuestion 바인딩후 Response응답 %s"), *String);
			//
			// UTextBlock* Title = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			// Title->SetText(FText::FromString(Rows.Response[0].title));
			// Title->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
			//
			// UTextBlock* Content = WidgetTree->ConstructWidget<UTextBlock>(UTextBlock::StaticClass());
			// Content->SetText(FText::FromString(Rows.Response[0].content));
			// Content->SetFont(FCoreStyle::GetDefaultFontStyle("regular",16));
			// Content->SetAutoWrapText(true);
			//
			// this->InputQuestion->SetVisibility(ESlateVisibility::Collapsed);
			// this->LeftVerticalBox->AddChild(Title);
			// this->LeftVerticalBox->AddChild(Content);
			// ResponseWorld->SetText(FText::FromString(String));
			// this->RightVerticalBox->AddChild(ResponseWorld);
		});
		UE_LOG(LogTemp, Display, TEXT("OnInputQuestion %s"), *Text.ToString());
		// Api->GenerateWorldPipeline(Text.ToString());
		Api->GenerateNextWorld(Text.ToString());
	}
}
